<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search decide Debug Test</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        margin: 15px 0;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .test-section h2 {
        margin-top: 0;
        font-size: 18px;
      }
      .result {
        padding: 12px 16px;
        margin: 8px 0;
        border-radius: 8px;
        font-family: monospace;
      }
      .pass {
        background: rgba(40, 167, 69, 0.3);
        border-left: 4px solid #28a745;
      }
      .fail {
        background: rgba(220, 53, 69, 0.3);
        border-left: 4px solid #dc3545;
      }
      .info {
        background: rgba(0, 123, 255, 0.3);
        border-left: 4px solid #007bff;
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .summary {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        padding: 15px 25px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
      }
      .log-container {
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
        margin-top: 10px;
      }
      .log-entry {
        margin: 4px 0;
      }
      .log-time {
        color: #888;
        margin-right: 8px;
      }
      .log-info {
        color: #28a745;
      }
      .log-error {
        color: #dc3545;
      }
      .log-warn {
        color: #ffc107;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ” Search decide åŠŸèƒ½æµ‹è¯•</h1>

    <div class="summary">
      <div>é€šè¿‡: <span id="passCount">0</span></div>
      <div>å¤±è´¥: <span id="failCount">0</span></div>
    </div>

    <div id="results"></div>

    <div class="test-section">
      <h2>ğŸ® æ‰‹åŠ¨æµ‹è¯•</h2>
      <button id="testNotification">æµ‹è¯•é€šçŸ¥</button>
      <button id="testClipboardRead">æµ‹è¯•è¯»å–å‰ªè´´æ¿</button>
      <button id="testToggleMonitoring">æµ‹è¯•åˆ‡æ¢ç›‘æ§</button>
      <button id="testOpenSidePanel">æµ‹è¯•æ‰“å¼€ä¾§è¾¹æ </button>
    </div>

    <div class="test-section">
      <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
      <div class="result info">
        <strong>Alt+K</strong> - åˆ‡æ¢å‰ªè´´æ¿ç›‘æ§<br />
        <strong>Alt+L</strong> - æ‰“å¼€ä¾§è¾¹æ <br />
        <strong>å¤åˆ¶æ–‡æœ¬</strong> - åº”è¯¥çœ‹åˆ°é€šçŸ¥
      </div>
    </div>

    <div class="test-section">
      <h2>ğŸ“ è¿è¡Œæ—¥å¿—</h2>
      <div class="log-container" id="logContainer"></div>
    </div>

    <script>
      const results = [];
      let passCount = 0;
      let failCount = 0;

      function log(message, type = "info") {
        const container = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const time = new Date().toLocaleTimeString();
        entry.innerHTML = `<span class="log-time">${time}</span><span class="log-${type}">${message}</span>`;
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
      }

      function addResult(name, passed, message = "") {
        results.push({ name, passed, message });
        const div = document.createElement("div");
        div.className = `result ${passed ? "pass" : "fail"}`;
        div.innerHTML = `${passed ? "âœ…" : "âŒ"} <strong>${name}</strong>${message ? "<br><small>" + message + "</small>" : ""}`;
        document.getElementById("results").appendChild(div);

        if (passed) {
          passCount++;
          document.getElementById("passCount").textContent = passCount;
        } else {
          failCount++;
          document.getElementById("failCount").textContent = failCount;
        }
      }

      // æµ‹è¯•1: æ£€æŸ¥Chrome APIå¯ç”¨æ€§
      async function testChromeAPI() {
        log("æ£€æŸ¥Chrome APIå¯ç”¨æ€§...", "info");

        const checks = [];

        // æ£€æŸ¥chromeå¯¹è±¡
        checks.push({
          name: "chromeå¯¹è±¡",
          passed: typeof chrome !== "undefined",
        });

        // æ£€æŸ¥runtime API
        if (typeof chrome !== "undefined" && chrome.runtime) {
          checks.push({ name: "chrome.runtime", passed: true });

          // æ£€æŸ¥sendMessage
          checks.push({
            name: "chrome.runtime.sendMessage",
            passed: typeof chrome.runtime.sendMessage === "function",
          });

          // æ£€æŸ¥onMessage
          checks.push({
            name: "chrome.runtime.onMessage",
            passed: !!chrome.runtime.onMessage,
          });

          // æ£€æŸ¥storage API
          if (chrome.storage) {
            checks.push({
              name: "chrome.storage.local",
              passed: !!chrome.storage.local,
            });
          } else {
            checks.push({
              name: "chrome.storage",
              passed: false,
              message: "storage APIä¸å¯ç”¨",
            });
          }
        } else {
          checks.push({
            name: "chrome.runtime",
            passed: false,
            message: "runtime APIä¸å¯ç”¨",
          });
        }

        const allPassed = checks.every((c) => c.passed);
        addResult(
          "Chrome APIæ£€æŸ¥",
          allPassed,
          checks
            .filter((c) => !c.passed)
            .map((c) => c.name + ": " + c.message)
            .join(", "),
        );

        checks.forEach((c) =>
          log(`${c.passed ? "âœ“" : "âœ—"} ${c.name}`, c.passed ? "info" : "error"),
        );

        return allPassed;
      }

      // æµ‹è¯•2: æ£€æŸ¥å‰ªè´´æ¿API
      async function testClipboardAPI() {
        log("æ£€æŸ¥å‰ªè´´æ¿API...", "info");

        const checks = [];

        // æ£€æŸ¥navigator.clipboard
        if (navigator.clipboard) {
          checks.push({ name: "navigator.clipboard", passed: true });

          // æ£€æŸ¥readText
          try {
            await navigator.clipboard.readText();
            checks.push({ name: "clipboard.readText", passed: true });
          } catch (e) {
            checks.push({
              name: "clipboard.readText",
              passed: false,
              message: e.name + ": " + e.message,
            });
          }

          // æ£€æŸ¥writeText
          try {
            await navigator.clipboard.writeText("test");
            checks.push({ name: "clipboard.writeText", passed: true });
          } catch (e) {
            checks.push({
              name: "clipboard.writeText",
              passed: false,
              message: e.name + ": " + e.message,
            });
          }
        } else {
          checks.push({
            name: "navigator.clipboard",
            passed: false,
            message: "clipboard APIä¸å¯ç”¨",
          });
        }

        const allPassed = checks.every((c) => c.passed);
        addResult(
          "å‰ªè´´æ¿APIæ£€æŸ¥",
          allPassed,
          checks
            .filter((c) => !c.passed)
            .map((c) => c.name + ": " + c.message)
            .join(", "),
        );

        checks.forEach((c) =>
          log(`${c.passed ? "âœ“" : "âœ—"} ${c.name}`, c.passed ? "info" : "error"),
        );

        return allPassed;
      }

      // æµ‹è¯•3: æ£€æŸ¥Storageæ•°æ®
      async function testStorage() {
        log("æ£€æŸ¥Storageæ•°æ®...", "info");

        try {
          const result = await chrome.storage.local.get([
            "globalMonitoringEnabled",
            "globalClipboardContent",
          ]);
          log(
            `globalMonitoringEnabled: ${result.globalMonitoringEnabled}`,
            "info",
          );
          log(
            `globalClipboardContenté•¿åº¦: ${result.globalClipboardContent?.length || 0}`,
            "info",
          );
          addResult(
            "Storageè¯»å–",
            true,
            `ç›‘æ§çŠ¶æ€: ${result.globalMonitoringEnabled}, å†…å®¹é•¿åº¦: ${result.globalClipboardContent?.length || 0}`,
          );
          return true;
        } catch (e) {
          log(`âœ— Storageè¯»å–å¤±è´¥: ${e.message}`, "error");
          addResult("Storageè¯»å–", false, e.message);
          return false;
        }
      }

      // æµ‹è¯•4: å‘é€æ¶ˆæ¯åˆ°Background
      async function testMessaging() {
        log("æµ‹è¯•æ¶ˆæ¯ä¼ é€’...", "info");

        try {
          const response = await chrome.runtime.sendMessage({
            action: "getGlobalMonitoringState",
          });
          log(`å“åº”: ${JSON.stringify(response)}`, "info");
          addResult("æ¶ˆæ¯é€šä¿¡", true, `ç›‘æ§çŠ¶æ€: ${response?.isActive}`);
          return true;
        } catch (e) {
          log(`âœ— æ¶ˆæ¯é€šä¿¡å¤±è´¥: ${e.message}`, "error");
          addResult("æ¶ˆæ¯é€šä¿¡", false, e.message);
          return false;
        }
      }

      // æµ‹è¯•5: æ£€æŸ¥Content ScriptçŠ¶æ€
      function testContentScript() {
        log("æ£€æŸ¥Content ScriptçŠ¶æ€...", "info");

        const checks = [];

        // æ£€æŸ¥å…¨å±€å¯¹è±¡
        if (window.__searchdecideGlobal) {
          checks.push({ name: "__searchdecideGlobal", passed: true });
          const state = window.__searchdecideGlobal.getState();
          log(`ç›‘æ§çŠ¶æ€: ${state.isMonitoring}`, "info");
          log(`æœ€åå†…å®¹é•¿åº¦: ${state.lastContent?.length || 0}`, "info");
          addResult(
            "Content ScriptçŠ¶æ€",
            true,
            `ç›‘æ§: ${state.isMonitoring}, å†…å®¹: ${state.lastContent?.length || 0}å­—ç¬¦`,
          );
        } else {
          checks.push({
            name: "__searchdecideGlobal",
            passed: false,
            message: "å…¨å±€å¯¹è±¡ä¸å­˜åœ¨",
          });
          addResult("Content ScriptçŠ¶æ€", false, "__searchdecideGlobalæœªå®šä¹‰");
        }

        return checks.every((c) => c.passed);
      }

      // æŒ‰é’®äº‹ä»¶å¤„ç†
      document
        .getElementById("testNotification")
        .addEventListener("click", () => {
          if (
            window.__searchdecideGlobal &&
            window.__searchdecideGlobal.showNotification
          ) {
            window.__searchdecideGlobal.showNotification(
              "æµ‹è¯•é€šçŸ¥ " + new Date().toLocaleTimeString(),
              "success",
            );
            log("âœ“ æ‰‹åŠ¨è§¦å‘é€šçŸ¥", "info");
          } else {
            log("âœ— æ— æ³•æ˜¾ç¤ºé€šçŸ¥", "error");
          }
        });

      document
        .getElementById("testClipboardRead")
        .addEventListener("click", async () => {
          try {
            const text = await navigator.clipboard.readText();
            log(
              `å‰ªè´´æ¿å†…å®¹: "${text.substring(0, 50)}${text.length > 50 ? "..." : ""}"`,
              "info",
            );
            if (
              window.__searchdecideGlobal &&
              window.__searchdecideGlobal.showNotification
            ) {
              window.__searchdecideGlobal.showNotification(
                "è¯»å–æˆåŠŸ: " + text.substring(0, 20) + "...",
                "info",
              );
            }
          } catch (e) {
            log(`âœ— è¯»å–å¤±è´¥: ${e.message}`, "error");
          }
        });

      document
        .getElementById("testToggleMonitoring")
        .addEventListener("click", async () => {
          try {
            const response = await chrome.runtime.sendMessage({
              action: "toggleGlobalMonitoring",
            });
            log(`åˆ‡æ¢ç›‘æ§: ${response.isActive}`, "info");
            if (
              window.__searchdecideGlobal &&
              window.__searchdecideGlobal.showNotification
            ) {
              window.__searchdecideGlobal.showNotification(
                `ç›‘æ§å·²${response.isActive ? "å¼€å¯" : "å…³é—­"}`,
                response.isActive ? "success" : "info",
              );
            }
          } catch (e) {
            log(`âœ— åˆ‡æ¢å¤±è´¥: ${e.message}`, "error");
          }
        });

      document
        .getElementById("testOpenSidePanel")
        .addEventListener("click", async () => {
          try {
            const [tab] = await chrome.tabs.query({
              active: true,
              currentWindow: true,
            });
            if (tab?.windowId) {
              await chrome.sidePanel.open({ windowId: tab.windowId });
              log("âœ“ ä¾§è¾¹æ å·²æ‰“å¼€", "info");
            }
          } catch (e) {
            log(`âœ— æ‰“å¼€å¤±è´¥: ${e.message}`, "error");
          }
        });

      // è¿è¡Œæ‰€æœ‰æµ‹è¯•
      async function runTests() {
        log("=".repeat(50), "info");
        log("å¼€å§‹æµ‹è¯•...", "info");

        await testChromeAPI();
        await testClipboardAPI();
        await testStorage();
        await testMessaging();
        testContentScript();

        log("=".repeat(50), "info");
        log(`æµ‹è¯•å®Œæˆ: é€šè¿‡ ${passCount}, å¤±è´¥ ${failCount}`, "info");
      }

      // é¡µé¢åŠ è½½åè¿è¡Œæµ‹è¯•
      setTimeout(runTests, 500);
    </script>
  </body>
</html>
